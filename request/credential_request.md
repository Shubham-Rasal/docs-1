# Credential Request Flow

The 3 steps in the credential request flow, from the recipient's perspective, are:

1. Initiate Request
2. Submit Credential Request
3. Receive Credential

## 1. Initiate Request

The goals of step 1 are to ensure the recipient is authenticated, and to navigate the recipient to the "request" page of the DCC wallet app.

The deep link into DCC wallet app first prompts the user to authenticate. The link can be emailed to eligible recipients or exposed as a QR code. DCC's current implementations use oauth 2.0, but this can be adapted to other flows.

`DEEP_LINK` contains information needed by the issuer and the DCC wallet app. Clicking on it opens the DCC wallet app with information it needs to kick off the authentication and request a credential.

> TO DISCUSS: request_url and challenge do not have to be in the initial deep link. Moving that to after auth response could cause the initial link provided to users be generic

```
dccrequest://request?                // DCC: mobile app deep link
    &auth_type=<auth_type>           // authentication protocol type (e.g. code, saml)
    &issuer=<issuer>                 // Key of the auth configuration
    &request_url=<request_url>       // DCC: credential request url
    &challenge=<challenge>           // DCC: challenge for signing
```

The issuer parameter is used to determine the [OpenID Connect Provider Config](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig); i.e. information such as:

- authorize_url
- token_url
- client_id

Clicking the link opens the DCC wallet app.]

## 2. Submit Credential Request

![](cred_request_cropped.jpg)

After authentication, the recipient is brought to the credential request page in the wallet, and asked to submit the request. 

### Implementation Details

The following information is used in the request:
- `request_url` (from `DEEP_LINK`) is the issuer's credential request endpoint the DCC client app will hit
    - May include additional parameters that the DCC client app will pass along. This is useful, for example, for specifying additional state needed to lookup the subject's credential to be issued 
    - e.g. [&issuance_id=<issuance_id>...]
- `challenge` (from `DEEP_LINK`) is included  in the signed message sent to the request URL
- `did` is generated by the wallet

The wallet uses `sign-and-verify` library to create and sign the VP in the following steps:

- Wallet creates a Verifiable Presentation with the following information
  - `did`
  - `challenge`
  - `presentation_id` (optional)
- Signs the VP
- On click, sends signed VP to `request_url`

[See detailed information about the credential request contract](https://github.com/digitalcredentials/sign-and-verify/blob/master/README.md#overview-of-credential-request-flow)

## 3. Receive credential

The issuer's credential request service performs the steps described in "Issue Credential Implementation", and returns the credential(s) to the recipient's wallet.

### Issue Credential Implementation

On the issuer side, the steps are:
1. Check auth state, as needed
2. Verify the subject's `did`
    - Use `sign-and-verify` library/service
    - Endpoint: `/verify/presentations`
    - [See detailed information](https://github.com/digitalcredentials/sign-and-verify/blob/master/README.md#did-proof-of-control-verification)
3. If verified, extract (and store) the subject's DID
4. Lookup/construct credential
    - Use session state to lookup which credential we want to issue to the subject, and construct credential
    - Add the subject DID (from step 3) to the credential (`credentialSubject.id`)
5. Sign (issue) the credential 
    - Use `sign-and-verify` library/service
    - Endpoint: `/issue/credentials`
6. Store credential and related accounting information
7. Return the VC

