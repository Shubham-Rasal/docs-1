# Credential Request Flow

The 3 steps in the credential request flow, from the recipient's perspective, are:

1. Initiate Request
2. Submit Credential Request
3. Receive Credential

## 1. Initiate Request

The goals of step 1 are to ensure the recipient is authenticated, and to navigate the recipient to the "request" page of the DCC wallet app.

The authentication method can be adapted to the issuer's requirements. Currently there are 2 methods used in DCC deployments:
1a. (Unauthenticated users) Deep link into DCC wallet app that prompts first for authentication
    - Link can be emailed to eligible recipients or exposed as a QR code
    - DCC's current implementations use oauth 2.0, but this can be adapted to other flows.
1b. (Authenticated users) QR scan to request 


### 1a. Deep link

TODO: Assumption: wallet app registers redirect uri with provider (if multiple providers, mobile app can select based on client id)

`DEEP_LINK` contains information needed by the issuer and the DCC wallet app:

```
dccrequest:request?                  // DCC: mobile app deep link
    authorize_url=<authorize_url>    // oauth authorize url
    &token_url=<token_url>           // oauth token url
    &client_id=<client_id>           // oauth client id: provided by issuer
    &response_type=code              // oauth response type
    &scope=<scope>                   // if needed by issuer
    &authorization_code=<authorization_code>  // TODO: discuss ttl, how to handle if authorization fails
    &request_url=<request_url>       // DCC: credential request url
    &challenge=<challenge>           // DCC: challege for signing
```

Clicking the link opens the DCC wallet app. The wallet will follow the issuer's authentication instructions provided in `DEEP_LINK`

### 1b. QR scan for authenticated recipient

Alteratively, if the recipient is already viewing an authenticated, the flow can be kicked off directly by a QR scan:

```
dccrequest:request?                  // DCC: mobile app deep link
    request_url=<request_url>        // DCC: credential request url
    &challenge=<challenge>           // DCC: challege for signing
```

## 2. Submit Credential Request

![](cred_request_cropped.jpg)

After authentication, the recipient is brought to the credential request page in the wallet, and asked to submit the request. 

### Implementation Details

The following information is used in the request:
- `request_url` (from `DEEP_LINK`) is the issuer's credential request endpoint the DCC client app will hit
    - May include additional parameters that the DCC client app will pass along. This is useful, for example, for specifying additional state needed to lookup the subject's credential to be issued 
    - e.g. [&issuance_id=<issuance_id>...]
- `challenge` (from `DEEP_LINK`) is included  in the signed message sent to the request URL
- `did` is generated by the wallet

The wallet uses `sign-and-verify` library to create and sign the VP in the following steps:

- Wallet creates a Verifiable Presentation with the following information
  - `did`
  - `challenge`
  - `presentation_id` (optional)
- Signs the VP
- On click, sends signed VP to `request_url`

[See detailed information about the credential request contract](https://github.com/digitalcredentials/sign-and-verify/blob/master/README.md#overview-of-credential-request-flow)

## 3. Receive credential

The issuer's credential request service performs the steps described in "Issue Credential Implementation", and returns the credential(s) to the recipient's wallet.

### Issue Credential Implementation

On the issuer side, the steps are:
1. Check auth state, as needed
2. Verify the subject's `did`
    - Use `sign-and-verify` library/service
    - Endpoint: `/verify/presentations`
    - [See detailed information](https://github.com/digitalcredentials/sign-and-verify/blob/master/README.md#did-proof-of-control-verification)
3. If verified, extract (and store) the subject's DID
4. Lookup/construct credential
    - Use session state to lookup which credential we want to issue to the subject, and construct credential
    - Add the subject DID (from step 3) to the credential (`credentialSubject.id`)
5. Sign (issue) the credential 
    - Use `sign-and-verify` library/service
    - Endpoint: `/issue/credentials`
6. Store credential and related accounting information
7. Return the VC

